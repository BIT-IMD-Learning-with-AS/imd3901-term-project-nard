<!DOCTYPE html>
<html>
    <head>
      <meta name="description" content="NARD's Beta Prototype!">
      
      <!-- DO NOT TOUCH 
      <script src="/js/aframe.min.js"></script>-->
      <script src="https://aframe.io/releases/1.1.0/aframe.min.js"></script>
      <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
      <script src="https://unpkg.com/aframe-environment-component@1.1.0/dist/aframe-environment-component.min.js"></script>
      <script src="https://unpkg.com/aframe-event-set-component@3.0.3/dist/aframe-event-set-component.min.js"></script>
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
      <!-- DO NOT TOUCH -->

      <link rel="stylesheet" href="/css/artifactEvironmentCSS.css">

      <script>

        var artifactClick = false;
        
        // Artifact rotation
        AFRAME.registerComponent('drag-rotate-component',{
            schema : { speed : {default:1}},
            init : function(){
              this.ifMouseDown = false;
              this.x_cord = 0;
              //this.y_cord = 0;
              document.addEventListener('mousedown',this.OnDocumentMouseDown.bind(this));
              document.addEventListener('mouseup',this.OnDocumentMouseUp.bind(this));
              document.addEventListener('mousemove',this.OnDocumentMouseMove.bind(this));
            },
            OnDocumentMouseDown : function(event){
              this.ifMouseDown = true;
              this.x_cord = event.clientX;
              //this.y_cord = event.clientY;
            },
            OnDocumentMouseUp : function(){
              this.ifMouseDown = false;
            },
            OnDocumentMouseMove : function(event)
            {
              if(this.ifMouseDown)
              {
                var temp_x = event.clientX-this.x_cord;
                this.el.object3D.rotateY(temp_x*this.data.speed/300);
                this.x_cord = event.clientX;
                //var temp_y = event.clientY-this.y_cord;
                //this.el.object3D.rotateX(temp_y*this.data.speed/400)
                //this.y_cord = event.clientY;
              }
            }
        });

        // Registering a-scene
        AFRAME.registerComponent('explore-experience', {
          init: function () {
            console.log('scene loaded');

            // Fade out
            var player = document.getElementById("player");
            let blocker = document.createElement('a-sphere');
            blocker.setAttribute('radius', '0.05');
            blocker.setAttribute('material', "shader:flat; color: white; opacity: 1.0; side: double");
            blocker.setAttribute('id', "artifact");
            blocker.setAttribute('animation', 'property: material.opacity; from: 1.0; to: 0.0 dur: 500; dir: alternate;');
            player.appendChild(blocker);
          }
        });
        
        // ON TO THE NEXT SCENE
        const contactExperience = function() {
          artifactFound = true;

          // Fade out
          var player = document.getElementById("player");
          let blocker = document.createElement('a-sphere');
          blocker.setAttribute('radius', '0.05');
          blocker.setAttribute('material', "shader:flat; color: white; opacity: 0.0; side: double");
          blocker.setAttribute('id', "artifact");
          blocker.setAttribute('animation', 'property: material.opacity; from: 0.0; to: 1.0 dur: 500; dir: alternate;');
          player.appendChild(blocker);

          let artifactText = document.querySelector('#artifact-info');
          artifactText.remove();
          let artifactBtn = document.querySelector('#item-overlay');
          artifactBtn.remove();

          // Timer before fade out
          setTimeout(function () {
            window.location.replace("http://localhost:8080/preContact.html");
          }, 1500);
        }
        
        // CLICK EVENTS
        const onClick = (event) => {
          // Finding artifact
          if(event.srcElement.id == "artifact"){
              console.log("ARTIFACT FOUND")

              if(artifactClick == false){
                var player = document.getElementById("player");
                var indicator = document.getElementById("indicator");
                var point = document.getElementById("cameraDot");
                player.setAttribute("look-controls", { enabled: false, reverseMouseDrag: true });     
                player.setAttribute("wasd-controls", { enabled: false}); 
                player.setAttribute("rotation", "-15 0 0"); 
                point.setAttribute("material", "opacity:0");     
                event.srcElement.parentElement.removeChild(event.srcElement);

                var posX = player.getAttribute('position').x;
                var posZ = player.getAttribute('position').z;
                var posY = player.getAttribute('position').y;

                let scene = document.querySelector('a-scene');

                let artifact = document.createElement('a-entity');
                artifact.setAttribute('gltf-model', '#totemModel');
                artifact.setAttribute('position', posX +" "+(posY - 0.2)+" "+(posZ-2));
                artifact.setAttribute('scale', "0.5 0.5 0.5");
                artifact.setAttribute('id', "artifact");
                artifact.setAttribute('drag-rotate-component', {});
                scene.appendChild(artifact);
                document.querySelector('#item-overlay').style.display='flex';
                scene.style.cursor = "pointer";

                let myElm = document.createElement("p");
                var textNode = document.createTextNode("Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum."); 
                myElm.appendChild(textNode);
                document.getElementById("artifact-info").appendChild(myElm);

                artifactClick = true;
            }
          }
        } 
        window.addEventListener('click', onClick);

        // Eye Indicator looks at camera
        AFRAME.registerComponent('look-at', {
          schema: { type: 'selector' },
          init: function () {},
          tick: function () {
            this.el.object3D.lookAt(this.data.object3D.position)
          }
        });
      </script>

    </head>
    <body>
      <!-- item button -->
      <div id="item-overlay" style="display:none; align-items: center; justify-content: center;">
        <button id="item-button" style= "bottom:10%" onclick="contactExperience();">Collect</button>
      </div>
      <!-- item description -->
        <div class="center" id="artifact-info">
        </div>

      <!-- A-SCENE -->
      <a-scene explore-experience environment="preset: forest; shadow: true" physics>

        <a-entity light="type: spot; angle: -45" position="0, 30, 51"></a-entity>

        <a-assets>
          <a-asset-item id="totemModel" response-type="arraybuffer" src="assets/Turtle_Rattlee/turtle_rattle.gltf"></a-asset-item>
        </a-assets>

        <!-- RIVER -->
        <a-ocean color="#3D8695" depth="100" width="100" density="60" position="0 0.4 48.5"></a-ocean>

        <!-- artifact -->
        <a-entity gltf-model= "#totemModel" id="artifact" position="0 0.5 -10" scale="0.5 0.5 0.5">
          <!-- indicator -->
          <a-image look-at="#player" id="indicator" src="assets/eyeIndicator.png" position="0 2 0" scale="0.5 0.3 0.5"></a-image>
        </a-entity>

        <!-- canoe -->
        <a-box boat id="canoe" position="0 0.4 -1" scale="1 1 3" material="color:brown"> </a-box>
        
        <!-- DO NOT TOUCH camera-->
        <a-entity camera id="player" position="0 2 0" wasd-controls look-controls >
          <a-entity cursor id="cameraDot" position="0 0 -1"
                    geometry="primitive: sphere; radius:0.008"
                    material="color:black; shader:flat; opacity:0.5"></a-entity>
        </a-entity>

    </a-scene>
  </body>
</html>