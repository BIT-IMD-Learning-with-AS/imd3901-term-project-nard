<!DOCTYPE html>
<html>
    <head>
      <meta name="description" content="NARD's Beta Prototype!">
      
      <!-- DO NOT TOUCH 
      <script src="/js/aframe.min.js"></script>-->
      <script src="https://aframe.io/releases/1.1.0/aframe.min.js"></script>
      <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
      <script src="https://unpkg.com/aframe-environment-component@1.1.0/dist/aframe-environment-component.min.js"></script>
      <script src="https://unpkg.com/aframe-event-set-component@3.0.3/dist/aframe-event-set-component.min.js"></script>
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
      <script src="https://cdn.rawgit.com/mrturck/aframe-joystick/master/joystick.min.js"></script>
      <!-- DO NOT TOUCH -->

      <link rel="stylesheet" href="/css/artifactEvironmentCSS.css">

      <script>

        // MOBILE artifact rotation
        function myFunction(event) {
          var x = event.touches[0].clientX;
          var entityEl = document.querySelector('#artifact');
          var rot = entityEl.getAttribute('rotation');
          if(x < oldFingerPos){
            entityEl.setAttribute('rotation', '0 ' + (rot.y - 6) + ' 0');
            oldFingerPos = x;
          }
          else{
            entityEl.setAttribute('rotation', '0 '+ (rot.y + 6) + ' 0');
            oldFingerPos = x;
          }    
        }     
        
        var oldFingerPos = 200;

        var artifactClick = false;
        
        // Artifact rotation
        AFRAME.registerComponent('drag-rotate-component',{
            schema : { speed : {default:1}},
            init : function(){
              this.ifMouseDown = false;
              this.x_cord = 0;
              //this.y_cord = 0;
              document.addEventListener('mousedown',this.OnDocumentMouseDown.bind(this));
              document.addEventListener('mouseup',this.OnDocumentMouseUp.bind(this));
              document.addEventListener('mousemove',this.OnDocumentMouseMove.bind(this));
            },
            OnDocumentMouseDown : function(event){
              this.ifMouseDown = true;
              this.x_cord = event.clientX;
              //this.y_cord = event.clientY;
            },
            OnDocumentMouseUp : function(){
              this.ifMouseDown = false;
            },
            OnDocumentMouseMove : function(event)
            {
              if(this.ifMouseDown)
              {
                var temp_x = event.clientX-this.x_cord;
                this.el.object3D.rotateY(temp_x*this.data.speed/200);
                this.x_cord = event.clientX;
                //var temp_y = event.clientY-this.y_cord;
                //this.el.object3D.rotateX(temp_y*this.data.speed/400)
                //this.y_cord = event.clientY;
              }
            }
        });

        // Registering a-scene
        AFRAME.registerComponent('explore-experience', {
          init: function () {
            console.log('scene loaded');

            // Fade in
            var camera = document.getElementById("camera");
            let blocker = document.createElement('a-sphere');
            blocker.setAttribute('radius', '0.05');
            blocker.setAttribute('material', "shader:flat; color: white; opacity: 1.0; side: double");
            blocker.setAttribute('id', "fade");
            blocker.setAttribute('animation', 'property: material.opacity; from: 1.0; to: 0.0 dur: 500; dir: alternate;');
            camera.appendChild(blocker);
          }
        });
        
        // ON TO THE NEXT SCENE
        const contactExperience = function() {
          artifactFound = true;

          // Fade out
          var camera = document.getElementById("camera");
          let blocker = document.createElement('a-sphere');
          blocker.setAttribute('radius', '0.05');
          blocker.setAttribute('material', "shader:flat; color: white; opacity: 0.0; side: double");
          blocker.setAttribute('id', "fade");
          blocker.setAttribute('animation', 'property: material.opacity; from: 0.0; to: 1.0 dur: 500; dir: alternate;');
          camera.appendChild(blocker);

          let artifactText = document.querySelector('#artifact-info');
          artifactText.remove();
          let artifactBtn = document.querySelector('#item-overlay');
          artifactBtn.remove();

          // Timer before fade out
          setTimeout(function () {
            window.location.replace("http://localhost:8080/postContact.html");
          }, 1500);
        }
        
        // CLICK EVENTS
        const onClick = (event) => {
          // Finding artifact
          if(event.srcElement.id == "artifact"){
              console.log("ARTIFACT FOUND")

              if(artifactClick == false){
                var camera = document.getElementById("camera");
                var indicator = document.getElementById("indicator");
                var point = document.getElementById("cameraDot");
                camera.setAttribute("look-controls", { enabled: false, reverseMouseDrag: true });     
                camera.setAttribute("wasd-controls", { enabled: false}); 
                camera.setAttribute("rotation", "-15 0 0"); 
                point.setAttribute("material", "opacity:0");     
                event.srcElement.parentElement.removeChild(event.srcElement);

                var posX = camera.getAttribute('position').x;
                var posZ = camera.getAttribute('position').z;
                var posY = camera.getAttribute('position').y;

                let scene = document.querySelector('a-scene');

                let artifact = document.createElement('a-entity');
                artifact.setAttribute('gltf-model', '#totemModel');
                artifact.setAttribute('position', posX +" "+(posY - 0.2)+" "+(posZ-2));
                artifact.setAttribute('scale', "1 1 1");
                artifact.setAttribute('rotation', "0 30 0");
                artifact.setAttribute('id', "artifact");
                artifact.setAttribute('drag-rotate-component', {});
                scene.appendChild(artifact);
                document.querySelector('#item-overlay').style.display='flex';
                scene.style.cursor = "pointer";

                let myElm = document.createElement("p");
                myElm.setAttribute('style', 'font-size: 130%;');
                var textNode = document.createTextNode("This is a baby's Áhta’, also known as a baby's shoe. A shoe is usually made from deer, elk, moose or buffalo leather and sewn with sinew. This item is important as it protects their feet from getting injured by sharp objects on the floor and keeps them warm during the winter."); 
                myElm.appendChild(textNode);
                document.getElementById("artifact-info").appendChild(myElm);

                // mobile movement block
                var blocker = document.querySelector('#mobileBlocker');
                blocker.style.position = 'absolute';
                var swipeSec = document.querySelector('#artifact-area');
                swipeSec.style.top = '200px';

                artifactClick = true;
            }
          }
        } 
        window.addEventListener('click', onClick);

        // Eye Indicator looks at camera
        AFRAME.registerComponent('look-at', {
          schema: { type: 'selector' },
          init: function () {},
          tick: function () {
            this.el.object3D.lookAt(this.data.object3D.position)
          }
        });
      </script>

    </head>
    <body>
      <!-- item button -->
      <div id="item-overlay" style="display:none; align-items: center; justify-content: center;">
        <button id="item-button" style= "bottom:10%" onclick="contactExperience();">Collect</button>
      </div>
      <!-- item description -->
        <div class="center" id="artifact-info">
        </div>

        <!-- mobile -->
        <div ontouchmove="myFunction(event)" id="artifact-area">
        </div>
        <div id="mobileBlocker">
        </div>

      <!-- A-SCENE -->
      <a-scene explore-experience environment="preset: forest; groundTexture:walkernoise; shadow: true" physics joystick vr-mode-ui="enabled: false">

        <a-entity light="type: spot; angle: -45" position="0, 30, 51"></a-entity>

        <a-assets>
          <a-asset-item id="totemModel" response-type="arraybuffer" src="assets/oneMoc/oneMoc.glb"></a-asset-item>
        </a-assets>

        <!-- RIVER -->
        <a-ocean color="#3D8695" depth="100" width="100" density="60" position="0 0.4 48.5"></a-ocean>

        <!-- artifact -->
        <a-entity gltf-model= "#totemModel" id="artifact" position="7 0.2 -9" scale="0.5 0.5 0.5">
          <!-- indicator -->
         <a-image look-at="#camera" id="indicator" src="assets/eyeIndicator.png" position="0 1 0" scale="0.5 0.3 0.5"></a-image>
        </a-entity>

        <!-- canoe -->
        <a-assets>
          <a-asset-item id="canoeModel" response-type="arraybuffer" src="assets/canoe/canoe.glb"></a-asset-item>
        </a-assets>

       <a-entity boat gltf-model= "#canoeModel" id="canoe" position="0 0.909 1.822" rotation="0 90 0" scale="0.250 0.160 0.140"  > </a-entity>
        
        <!-- DO NOT TOUCH camera-->
        <a-entity camera id="camera" position="0 2 0" wasd-controls look-controls >
          <a-entity cursor id="cameraDot" position="0 0 -1"
                    geometry="primitive: sphere; radius:0.008"
                    material="color:black; shader:flat; opacity:0.5"></a-entity>
        </a-entity>

    </a-scene>
  </body>
</html>